# Template file for 'openttd'
pkgname=openttd
version=12.2
revision=1
_gfxver=7.1
_sfxver=1.0.3
_msxver=0.4.2
create_wrksrc=yes
build_wrksrc=${pkgname}-$version
build_style=cmake
configure_args="-DCMAKE_INSTALL_DATADIR=share -DCMAKE_INSTALL_BINDIR=bin"
hostmakedepends="pkg-config $(vopt_if sdl2 SDL2-devel sdl-devel)"
makedepends="$(vopt_if sdl2 SDL2-devel sdl-devel) icu-devel fontconfig-devel
libpng-devel lzo-devel liblzma-devel libxdg-basedir-devel zlib-devel
freetype-devel fluidsynth-devel"
depends="hicolor-icon-theme"
short_desc="Open Source version of Transport Tycoon Deluxe"
maintainer="Enrico Belleri <idesmi@protonmail.com>"
license="GPL-2.0-only, Zlib"
homepage="https://www.openttd.org"
changelog="https://raw.githubusercontent.com/OpenTTD/OpenTTD/release/12/changelog.txt"
distfiles="https://cdn.openttd.org/openttd-releases/${version}/${pkgname}-${version}-source.tar.xz
 https://cdn.openttd.org/opengfx-releases/${_gfxver}/opengfx-${_gfxver}-all.zip
 https://cdn.openttd.org/opensfx-releases/${_sfxver}/opensfx-${_sfxver}-all.zip
 https://cdn.openttd.org/openmsx-releases/${_msxver}/openmsx-${_msxver}-all.zip"
checksum="81508f0de93a0c264b216ef56a05f8381fff7bffa6d010121a21490b4dace95c
 928fcf34efd0719a3560cbab6821d71ce686b6315e8825360fba87a7a94d7846
 e0a218b7dd9438e701503b0f84c25a97c1c11b7c2f025323fb19d6db16ef3759
 5a4277a2e62d87f2952ea5020dc20fb2f6ffafdccf9913fbf35ad45ee30ec762"
build_options="sdl2"
desc_option_sdl2="Use Simple DirectMedia Layer 2.0"
build_options_default="sdl2"

if [ "$CROSS_BUILD" ]; then
	pre_configure() {
		mkdir -p native
		cd native
		env -i PATH=$PATH cmake .. -DOPTION_TOOLS_ONLY=ON
		make ${makejobs}
	}

	configure_args+=" -DHOST_BINARY_DIR=/builddir/${pkgname}-${version}/${wrksrc}/${build_wrksrc}/native"
fi

post_extract() {
	cd $wrksrc
	bsdtar xf opengfx-${_gfxver}.tar
	rm -f opengfx-${_gfxver}.tar
	bsdtar xf opensfx-${_sfxver}.tar
	rm -f opensfx-${_sfxver}.tar
	bsdtar xf openmsx-${_msxver}.tar
	rm -f openmsx-${_msxver}.tar
}

# test requires opengfx
pre_check() {
	mkdir build/data
	cp ../opengfx-${_gfxver}/*.grf build/data
	cp ../opengfx-${_gfxver}/*.obg build/data
	if [ "$XBPS_TARGET_LIBC" = musl ]; then
		vsed -i build/ai/regression/result.txt -e 's/(null : 0x00000000)/(null : 0x0)/'
	fi
}

post_install() {
	vmkdir usr/share/openttd/data/opengfx
	vmkdir usr/share/openttd/data/opensfx
	vmkdir usr/share/openttd/data/openmsx
	vcopy ../opengfx-${_gfxver}/*.grf usr/share/openttd/data/opengfx
	vcopy ../opengfx-${_gfxver}/*.obg usr/share/openttd/data/opengfx
	vcopy ../opensfx-${_sfxver}/*.cat usr/share/openttd/data/opensfx
	vcopy ../opensfx-${_sfxver}/*.obs usr/share/openttd/data/opensfx
	vcopy ../openmsx-${_msxver}/*.mid usr/share/openttd/data/openmsx
	vcopy ../openmsx-${_msxver}/*.obm usr/share/openttd/data/openmsx
	vlicense ../opengfx-${_gfxver}/license.txt LICENSE-gfx
	vlicense ../opensfx-${_sfxver}/license.txt LICENSE-sfx
	vlicense ../openmsx-${_msxver}/license.txt LICENSE-msx
	vdoc ../opengfx-${_gfxver}/readme.txt README-gfx
	vdoc ../opensfx-${_sfxver}/readme.txt README-sfx
	vdoc ../openmsx-${_msxver}/readme.txt README-msx
}
